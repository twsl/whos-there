---
name: Release

on:
  release:
    types: [published]

env:
  python-version: "3.11"

jobs:
  release:
    name: Release package
    runs-on: ['ubuntu-latest']
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Free Disk Space
        uses: twsl/gha-free-disk-space@v1

      - name: Set up Python ${{ env.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.python-version }}

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          cache-dependency-glob: "**/uv.lock"

      - name: Install dependencies
        run: uv sync --all-groups --all-extras --frozen

      - name: Build dependencies
        run: uv build

      - name: Upload artifacts
        uses: actions/upload-artifact@v6
        with:
          name: build-${{ github.sha }}
          path: dist/

      - name: Show
        run: ls -l dist/

      - name: Publish
        run: |
          uv publish --username "__token__" --password ${{ secrets.PYPI_API_TOKEN }}

  upload-packages:
    runs-on: ["ubuntu-latest"]
    permissions: write-all
    needs: release
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Download artifacts
        uses: actions/download-artifact@v7
        with:
          name: build-${{ github.sha }}
          path: dist/

      - name: Upload to release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.event.ref, 'refs/tags') || github.event_name == 'release'
        with:
          files: dist/*
